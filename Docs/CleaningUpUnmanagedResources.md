# ê´€ë¦¬ë˜ì§€ ì•Šì€ ë¦¬ì†ŒìŠ¤ ì •ë¦¬

ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ìƒì„±í•˜ëŠ” ëŒ€ë¶€ë¶„ì˜ ê°ì²´ì— ëŒ€í•´ì„œëŠ” .NETì˜ ê°€ë¹„ì§€ ì»¬ë ‰í„°ê°€ ë©”ëª¨ë¦¬ ê´€ë¦¬ë¥¼ ì²˜ë¦¬í•˜ë„ë¡ ë§¡ê¸¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ ê´€ë¦¬ë˜ì§€ ì•ŠëŠ” ë¦¬ì†ŒìŠ¤ë¥¼ í¬í•¨í•˜ëŠ” ê°ì²´ë¥¼ ìƒì„±í•  ê²½ìš°, ì‚¬ìš©ì„ ë§ˆì¹œ í›„ì— ì´ëŸ¬í•œ ë¦¬ì†ŒìŠ¤ë¥¼ ëª…ì‹œì ìœ¼ë¡œ í•´ì œí•´ì•¼ í•©ë‹ˆë‹¤. ê°€ì¥ ì¼ë°˜ì ì¸ ê´€ë¦¬ë˜ì§€ ì•ŠëŠ” ë¦¬ì†ŒìŠ¤ëŠ” íŒŒì¼, ì°½, ë„¤íŠ¸ì›Œí¬ ì—°ê²° ë˜ëŠ” ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°ê³¼ ê°™ì€ ìš´ì˜ ì²´ì œ ë¦¬ì†ŒìŠ¤ë¥¼ ë˜í•‘í•˜ëŠ” ê°ì²´ë“¤ì…ë‹ˆë‹¤. ê°€ë¹„ì§€ ì»¬ë ‰í„°ëŠ” ê´€ë¦¬ë˜ì§€ ì•ŠëŠ” ë¦¬ì†ŒìŠ¤ë¥¼ ìº¡ìŠí™”í•˜ëŠ” ê°ì²´ì˜ ìˆ˜ëª…ì€ ì¶”ì í•  ìˆ˜ ìˆì§€ë§Œ, ì´ëŸ¬í•œ ê´€ë¦¬ë˜ì§€ ì•ŠëŠ” ë¦¬ì†ŒìŠ¤ë¥¼ í•´ì œí•˜ê³  ì •ë¦¬í•˜ëŠ” ë°©ë²•ì€ ì•Œì§€ ëª»í•©ë‹ˆë‹¤.

ê°ì²´ê°€ ê´€ë¦¬ë˜ì§€ ì•ŠëŠ” ë¦¬ì†ŒìŠ¤ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²½ìš°, ë‹¤ìŒ ì‚¬í•­ì„ ìˆ˜í–‰í•´ì•¼ í•©ë‹ˆë‹¤:

- Dispose íŒ¨í„´ì„ êµ¬í˜„í•˜ì„¸ìš”. ì´ë¥¼ ìœ„í•´ `IDisposable.Dispose`ë¥¼ êµ¬í˜„í•˜ì—¬ ê´€ë¦¬ë˜ì§€ ì•ŠëŠ” ë¦¬ì†ŒìŠ¤ë¥¼ ëª…í™•í•˜ê²Œ í•´ì œí•  ìˆ˜ ìˆê²Œ í•´ì•¼ í•©ë‹ˆë‹¤. íƒ€ì…ì˜ ì‚¬ìš©ìê°€ í•´ë‹¹ ê°ì²´(ê·¸ë¦¬ê³  ê·¸ ê°ì²´ê°€ ì‚¬ìš©í•˜ëŠ” ë¦¬ì†ŒìŠ¤)ê°€ ë” ì´ìƒ í•„ìš”í•˜ì§€ ì•Šì„ ë•Œ `Dispose`ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤. `Dispose` ë©”ì„œë“œëŠ” ê´€ë¦¬ë˜ì§€ ì•ŠëŠ” ë¦¬ì†ŒìŠ¤ë¥¼ ì¦‰ì‹œ í•´ì œí•©ë‹ˆë‹¤.

- íƒ€ì…ì˜ ì‚¬ìš©ìê°€ `Dispose` í˜¸ì¶œì„ ê¹œë¹¡í–ˆì„ ê²½ìš°, ê´€ë¦¬ë˜ì§€ ì•ŠëŠ” ë¦¬ì†ŒìŠ¤ë¥¼ í•´ì œí•  ìˆ˜ ìˆëŠ” ë°©ë²•ì„ ì œê³µí•´ì•¼ í•©ë‹ˆë‹¤. ì´ ë°©ë²•ì—ëŠ” ë‘ ê°€ì§€ê°€ ìˆìŠµë‹ˆë‹¤:
  
  - ì•ˆì „ í•¸ë“¤ì„ ì‚¬ìš©í•˜ì—¬ ê´€ë¦¬ë˜ì§€ ì•ŠëŠ” ë¦¬ì†ŒìŠ¤ë¥¼ ë˜í•‘í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. ì´ ë°©ë²•ì´ ê¶Œì¥ë©ë‹ˆë‹¤. ì•ˆì „ í•¸ë“¤ì€ `System.Runtime.InteropServices.SafeHandle` ì¶”ìƒ í´ë˜ìŠ¤ì—ì„œ íŒŒìƒë˜ë©°, ê²¬ê³ í•œ `Finalize` ë©”ì„œë“œë¥¼ í¬í•¨í•˜ê³  ìˆìŠµë‹ˆë‹¤. ì•ˆì „ í•¸ë“¤ì„ ì‚¬ìš©í•  ê²½ìš°, ë‹¨ìˆœíˆ `IDisposable` ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•˜ê³ , `IDisposable.Dispose` êµ¬í˜„ ë‚´ì—ì„œ ì•ˆì „ í•¸ë“¤ì˜ `Dispose` ë©”ì„œë“œë¥¼ í˜¸ì¶œí•˜ë©´ ë©ë‹ˆë‹¤. ì•ˆì „ í•¸ë“¤ì˜ `Dispose`ê°€ í˜¸ì¶œë˜ì§€ ì•Šìœ¼ë©´, ê°€ë¹„ì§€ ì»¬ë ‰í„°ê°€ ì•ˆì „ í•¸ë“¤ì˜ íŒŒì´ë„ë¼ì´ì €ë¥¼ ìë™ìœ¼ë¡œ í˜¸ì¶œí•©ë‹ˆë‹¤.
  - íŒŒì´ë„ë¼ì´ì €ë¥¼ ì •ì˜í•˜ì„¸ìš”. íŒŒì´ë„ë¼ì´ì €ëŠ” íƒ€ì…ì˜ ì‚¬ìš©ìê°€ `IDisposable.Dispose`ë¥¼ í˜¸ì¶œí•˜ì§€ ì•Šì•„ë„ ê´€ë¦¬ë˜ì§€ ì•ŠëŠ” ë¦¬ì†ŒìŠ¤ë¥¼ ë¹„ê²°ì •ì ìœ¼ë¡œ í•´ì œí•  ìˆ˜ ìˆê²Œ í•©ë‹ˆë‹¤.

> âš ï¸ ê²½ê³ 
> 
> ê°ì²´ íŒŒì´ë„ë¼ì´ì œì´ì…˜ì€ ë³µì¡í•˜ê³  ì˜¤ë¥˜ë¥¼ ì¼ìœ¼í‚¤ê¸° ì‰¬ìš´ ì‘ì—…ì´ë¯€ë¡œ, ìì²´ íŒŒì´ë„ë¼ì´ì €ë¥¼ ì œê³µí•˜ê¸°ë³´ë‹¤ëŠ” ì•ˆì „ í•¸ë“¤ì„ ì‚¬ìš©í•˜ëŠ” ê²ƒì„ ê¶Œì¥í•©ë‹ˆë‹¤.

íƒ€ì…ì˜ ì‚¬ìš©ìëŠ” ê´€ë¦¬ë˜ì§€ ì•ŠëŠ” ë¦¬ì†ŒìŠ¤ê°€ ì‚¬ìš©í•˜ëŠ” ë©”ëª¨ë¦¬ë¥¼ í•´ì œí•˜ê¸° ìœ„í•´, `IDisposable.Dispose` êµ¬í˜„ì„ ì§ì ‘ í˜¸ì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. `Dispose` ë©”ì„œë“œë¥¼ ì˜¬ë°”ë¥´ê²Œ êµ¬í˜„í•˜ë©´, `Dispose` ë©”ì„œë“œê°€ í˜¸ì¶œë˜ì§€ ì•Šì€ ê²½ìš°ì—ë„ ì•ˆì „ í•¸ë“¤ì˜ `Finalize` ë©”ì„œë“œë‚˜ `Object.Finalize`ì˜ ì˜¤ë²„ë¼ì´ë“œê°€ ë¦¬ì†ŒìŠ¤ë¥¼ ì •ë¦¬í•˜ê¸° ìœ„í•œ ì•ˆì „ë§ ì—­í• ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.

## Dispose ë©”ì„œë“œ êµ¬í˜„

Dispose ë©”ì„œë“œëŠ” ì£¼ë¡œ ê´€ë¦¬ë˜ì§€ ì•ŠëŠ” ë¦¬ì†ŒìŠ¤ë¥¼ í•´ì œí•˜ê¸° ìœ„í•´ êµ¬í˜„ë©ë‹ˆë‹¤. IDisposableì„ êµ¬í˜„í•˜ëŠ” ì¸ìŠ¤í„´ìŠ¤ ë©¤ë²„ë¥¼ ì‚¬ìš©í•  ë•ŒëŠ”, ì¼ë°˜ì ìœ¼ë¡œ Dispose í˜¸ì¶œì„ ì—°ì‡„ì ìœ¼ë¡œ ì—°ê²°í•´ì„œ ì²˜ë¦¬í•©ë‹ˆë‹¤. Disposeë¥¼ êµ¬í˜„í•˜ëŠ” ë‹¤ë¥¸ ì´ìœ ë¡œëŠ”, í• ë‹¹ëœ ë©”ëª¨ë¦¬ë¥¼ í•´ì œí•˜ê±°ë‚˜, ì»¬ë ‰ì…˜ì— ì¶”ê°€ëœ í•­ëª©ì„ ì œê±°í•˜ê±°ë‚˜, íšë“í•œ ì ê¸ˆì˜ í•´ì œë¥¼ ì‹ í˜¸ë¡œ í‘œì‹œí•˜ëŠ” ê²½ìš° ë“±ì´ ìˆìŠµë‹ˆë‹¤.

.NETì˜ ê°€ë¹„ì§€ ì»¬ë ‰í„°ëŠ” ê´€ë¦¬ë˜ì§€ ì•ŠëŠ” ë©”ëª¨ë¦¬ë¥¼ í• ë‹¹í•˜ê±°ë‚˜ í•´ì œí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ê°ì²´ë¥¼ ì†Œë©¸ì‹œí‚¤ëŠ” íŒ¨í„´, ì¦‰ Dispose íŒ¨í„´ì€ ê°ì²´ì˜ ìˆ˜ëª… ì£¼ê¸°ë¥¼ ì²´ê³„ì ìœ¼ë¡œ ê´€ë¦¬í•˜ê¸° ìœ„í•œ ê²ƒì…ë‹ˆë‹¤. Dispose íŒ¨í„´ì€ IDisposable ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•˜ëŠ” ê°ì²´ì—ì„œ ì‚¬ìš©ë©ë‹ˆë‹¤. íŒŒì¼ ë° íŒŒì´í”„ í•¸ë“¤, ë ˆì§€ìŠ¤íŠ¸ë¦¬ í•¸ë“¤, ëŒ€ê¸° í•¸ë“¤ ë˜ëŠ” ê´€ë¦¬ë˜ì§€ ì•ŠëŠ” ë©”ëª¨ë¦¬ ë¸”ë¡ì— ëŒ€í•œ í¬ì¸í„°ì™€ ìƒí˜¸ ì‘ìš©í•  ë•Œ ì¼ë°˜ì ìœ¼ë¡œ ì´ íŒ¨í„´ì„ ì‚¬ìš©í•©ë‹ˆë‹¤. ì´ëŠ” ê°€ë¹„ì§€ ì»¬ë ‰í„°ê°€ ê´€ë¦¬ë˜ì§€ ì•ŠëŠ” ê°œì²´ë¥¼ íšŒìˆ˜í•  ìˆ˜ ì—†ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.

ë¦¬ì†ŒìŠ¤ê°€ í•­ìƒ ì ì ˆí•˜ê²Œ ì •ë¦¬ë˜ë„ë¡ ë³´ì¥í•˜ê¸° ìœ„í•´, Dispose ë©”ì„œë“œëŠ” ë©±ë“±ì„±(idempotent)ì„ ê°€ì ¸ì•¼ í•©ë‹ˆë‹¤. ì¦‰, ì—¬ëŸ¬ ë²ˆ í˜¸ì¶œë˜ì–´ë„ ì˜ˆì™¸ë¥¼ ë°œìƒì‹œí‚¤ì§€ ì•Šì•„ì•¼ í•˜ë©°, ì´í›„ì˜ Dispose í˜¸ì¶œì€ ì•„ë¬´ ì‘ì—…ë„ ìˆ˜í–‰í•˜ì§€ ì•Šì•„ì•¼ í•©ë‹ˆë‹¤.

GC.KeepAlive ë©”ì„œë“œ ì˜ˆì œëŠ” ê°œì²´ë‚˜ ê·¸ ë©¤ë²„ì— ëŒ€í•œ ê´€ë¦¬ë˜ì§€ ì•ŠëŠ” ì°¸ì¡°ê°€ ì—¬ì „íˆ ì‚¬ìš© ì¤‘ì¸ ë™ì•ˆ, ê°€ë¹„ì§€ ì»¬ë ‰ì…˜ìœ¼ë¡œ ì¸í•´ ì¢…ë£Œìê°€ í˜¸ì¶œë  ìˆ˜ ìˆìŒì„ ë³´ì—¬ì¤ë‹ˆë‹¤. í˜„ì¬ ë£¨í‹´ì˜ ì‹œì‘ë¶€í„° ì´ ë©”ì„œë“œê°€ í˜¸ì¶œë˜ëŠ” ì‹œì ê¹Œì§€ ê°œì²´ê°€ ê°€ë¹„ì§€ ì»¬ë ‰ì…˜ì˜ ëŒ€ìƒì´ ë˜ì§€ ì•Šë„ë¡ í•˜ë ¤ë©´, GC.KeepAliveë¥¼ í™œìš©í•˜ëŠ” ê²ƒì´ í•©ë¦¬ì ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

> ğŸ’¡ íŒ
> 
> ì˜ì¡´ì„± ì£¼ì…ê³¼ ê´€ë ¨í•˜ì—¬, `IServiceCollection`ì— ì„œë¹„ìŠ¤ë¥¼ ë“±ë¡í•  ë•ŒëŠ” ì„œë¹„ìŠ¤ì˜ ìˆ˜ëª…ì´ ìë™ìœ¼ë¡œ ê´€ë¦¬ë©ë‹ˆë‹¤. `IServiceProvider`ì™€ í•´ë‹¹ `IHost`ê°€ ë¦¬ì†ŒìŠ¤ ì •ë¦¬ë¥¼ ì¡°ìœ¨í•©ë‹ˆë‹¤. íŠ¹íˆ, `IDisposable` ë° `IAsyncDisposable`ì„ êµ¬í˜„í•˜ëŠ” ê²½ìš°, ì´ë“¤ì´ ëª…ì‹œëœ ìˆ˜ëª…ì´ ëë‚˜ë©´ ì ì ˆí•˜ê²Œ í•´ì œë©ë‹ˆë‹¤.
> 
> ìì„¸í•œ ë‚´ìš©ì€ [.NETì˜ ì˜ì¡´ì„± ì£¼ì… ë¬¸ì„œ]([Dependency injection - .NET | Microsoft Learn](https://learn.microsoft.com/en-us/dotnet/core/extensions/dependency-injection))ë¥¼ ì°¸ê³ í•˜ì„¸ìš”.

### ê³„ë‹¨ì‹ ì²˜ë¦¬ í•´ì œ í˜¸ì¶œ

í´ë˜ìŠ¤ê°€ IDisposableì„ êµ¬í˜„í•˜ëŠ” ë‹¤ë¥¸ íƒ€ì…ì˜ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì†Œìœ í•˜ê³  ìˆë‹¤ë©´, ê·¸ í¬í•¨í•˜ëŠ” í´ë˜ìŠ¤ ìì²´ë„ IDisposableì„ êµ¬í˜„í•´ì•¼ í•©ë‹ˆë‹¤. ì¼ë°˜ì ìœ¼ë¡œ IDisposable êµ¬í˜„ì²´ë¥¼ ì¸ìŠ¤í„´ìŠ¤ ë©¤ë²„(ë˜ëŠ” í”„ë¡œí¼í‹°)ë¡œ ë³´ìœ í•˜ëŠ” í´ë˜ìŠ¤ëŠ”, ì´ ë©¤ë²„ì˜ ì •ë¦¬ ì‘ì—…ë„ ì±…ì„ì§‘ë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ì°¸ì¡°ëœ IDisposable íƒ€ì…ì´ Dispose ë©”ì„œë“œë¥¼ í†µí•´ ëª…í™•í•˜ê²Œ ì •ë¦¬ ì‘ì—…ì„ ìˆ˜í–‰í•  ê¸°íšŒë¥¼ ê°€ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì•„ë˜ ì˜ˆì œì—ì„œ í´ë˜ìŠ¤ëŠ” `sealed`(ë˜ëŠ” Visual Basicì—ì„œëŠ” `NotInheritable`)ë¡œ ì„ ì–¸ë©ë‹ˆë‹¤.

```csharp
using System;

public sealed class Foo : IDisposable
{
    private readonly IDisposable _bar;

    public Foo()
    {
        _bar = new Bar();
    }

    public void Dispose() => _bar.Dispose();
}
```

> ğŸ’¡ íŒ
> 
> í´ë˜ìŠ¤ì— `IDisposable` í•„ë“œë‚˜ í”„ë¡œí¼í‹°ê°€ ìˆë”ë¼ë„, í•´ë‹¹ ë¦¬ì†ŒìŠ¤ì˜ ì†Œìœ ê¶Œì´ ì—†ë‹¤ë©´ `IDisposable`ì„ êµ¬í˜„í•  í•„ìš”ëŠ” ì—†ìŠµë‹ˆë‹¤. ì¼ë°˜ì ìœ¼ë¡œ `IDisposable` ê°ì²´ë¥¼ ìƒì„±í•˜ê³  ë³´ê´€í•˜ëŠ” í´ë˜ìŠ¤ê°€ ì†Œìœ ê¶Œì„ ê°–ì§€ë§Œ, ê²½ìš°ì— ë”°ë¼ ì´ ì†Œìœ ê¶Œì´ ë‹¤ë¥¸ `IDisposable` íƒ€ì…ìœ¼ë¡œ ì´ì „ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
> 
> ë˜í•œ, íŒŒì´ë„ë¼ì´ì €(ë˜ëŠ” íŒŒì´ë„ë¼ì´ì €ì— ì˜í•´ í˜¸ì¶œë˜ëŠ” `Dispose(false)` ë©”ì„œë“œ)ì—ì„œ null í™•ì¸ì„ ìˆ˜í–‰í•´ì•¼ í•  ë•Œê°€ ìˆìŠµë‹ˆë‹¤. ì£¼ëœ ì´ìœ  ì¤‘ í•˜ë‚˜ëŠ” ì¸ìŠ¤í„´ìŠ¤ê°€ ì™„ì „íˆ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ì„ ìˆ˜ ìˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤(ì˜ˆ: ìƒì„±ìì—ì„œ ì˜ˆì™¸ê°€ ë°œìƒí•œ ê²½ìš°).



### Dispose() ì™€ Dispose(bool)

`IDisposable` ì¸í„°í˜ì´ìŠ¤ëŠ” ë§¤ê°œë³€ìˆ˜ê°€ ì—†ëŠ” ë‹¨ì¼ ë©”ì„œë“œ `Dispose`ë¥¼ êµ¬í˜„í•˜ë„ë¡ ìš”êµ¬í•©ë‹ˆë‹¤. ë˜í•œ, `sealed`ê°€ ì•„ë‹Œ í´ë˜ìŠ¤ë¼ë©´ `Dispose(bool)` ì˜¤ë²„ë¡œë“œ ë©”ì„œë“œë¥¼ ë°˜ë“œì‹œ ì œê³µí•´ì•¼ í•©ë‹ˆë‹¤.

ë©”ì„œë“œ ì‹œê·¸ë‹ˆì²˜ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:

- `public` ë¹„ê°€ìƒ ë©”ì„œë“œ(`NotOverridable` in Visual Basic): `IDisposable.Dispose` êµ¬í˜„.

- `protected` ê°€ìƒ ë©”ì„œë“œ(`Overridable` in Visual Basic): `Dispose(bool)`.

#### Dispose() method

ê³µê°œì ì´ê³  ë¹„ê°€ìƒ(Visual Basicì˜ ê²½ìš° `NotOverridable`)ì¸ ë§¤ê°œë³€ìˆ˜ê°€ ì—†ëŠ” `Dispose` ë©”ì„œë“œëŠ”, íƒ€ì…ì˜ ì†Œë¹„ìê°€ ë” ì´ìƒ í•„ìš”í•˜ì§€ ì•Šì„ ë•Œ í˜¸ì¶œë©ë‹ˆë‹¤. ì´ ë©”ì„œë“œì˜ ëª©ì ì€ ê´€ë¦¬ë˜ì§€ ì•ŠëŠ” ë¦¬ì†ŒìŠ¤ë¥¼ í•´ì œí•˜ê³ , ì¼ë°˜ì ì¸ ì •ë¦¬ ì‘ì—…ì„ ìˆ˜í–‰í•˜ë©°, íŒŒì´ë„ë¼ì´ì €ê°€ ì¡´ì¬í•œë‹¤ë©´ ê·¸ê²ƒì´ ì‹¤í–‰ë  í•„ìš”ê°€ ì—†ìŒì„ ë‚˜íƒ€ë‚´ëŠ” ê²ƒì…ë‹ˆë‹¤. ê´€ë¦¬ë˜ëŠ” ê°ì²´ì— ì—°ê²°ëœ ì‹¤ì œ ë©”ëª¨ë¦¬ í•´ì œëŠ” í•­ìƒ ê°€ë¹„ì§€ ì»¬ë ‰í„°ì˜ ì—­í• ì…ë‹ˆë‹¤. ì´ëŸ¬í•œ ì´ìœ ë¡œ, ì´ ë©”ì„œë“œëŠ” í‘œì¤€ êµ¬í˜„ ë°©ì‹ì„ ë”°ë¦…ë‹ˆë‹¤:

```csharp
public void Dispose()
{
    // Dispose of unmanaged resources.
    Dispose(true);
    // Suppress finalization.
    GC.SuppressFinalize(this);
}
```

`Dispose` ë©”ì„œë“œëŠ” ê°ì²´ì˜ ëª¨ë“  ì •ë¦¬ ì‘ì—…ì„ ìˆ˜í–‰í•˜ë¯€ë¡œ, ê°€ë¹„ì§€ ì»¬ë ‰í„°ëŠ” ê°ì²´ì˜ `Object.Finalize` ì˜¤ë²„ë¼ì´ë“œë¥¼ ë” ì´ìƒ í˜¸ì¶œí•  í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤. ë”°ë¼ì„œ `SuppressFinalize` ë©”ì„œë“œë¥¼ í˜¸ì¶œí•˜ë©´ ê°€ë¹„ì§€ ì»¬ë ‰í„°ê°€ íŒŒì´ë„ë¼ì´ì €ë¥¼ ì‹¤í–‰í•˜ì§€ ì•Šë„ë¡ ë°©ì§€í•©ë‹ˆë‹¤. íƒ€ì…ì— íŒŒì´ë„ë¼ì´ì €ê°€ ì—†ë‹¤ë©´, `GC.SuppressFinalize` í˜¸ì¶œì€ ì•„ë¬´ëŸ° íš¨ê³¼ë„ ì—†ìŠµë‹ˆë‹¤. ì‹¤ì œ ì •ë¦¬ ì‘ì—…ì€ `Dispose(bool)` ë©”ì„œë“œ ì˜¤ë²„ë¡œë“œê°€ ìˆ˜í–‰í•©ë‹ˆë‹¤.

#### Dispose(bool) method overload

ì´ ì˜¤ë²„ë¡œë“œì—ì„œ `disposing` ë§¤ê°œë³€ìˆ˜ëŠ” í˜¸ì¶œì´ `Dispose` ë©”ì„œë“œì—ì„œ ì˜¨ ê²ƒì¸ì§€(ê°’ì´ `true`) ë˜ëŠ” íŒŒì´ë„ë¼ì´ì €ì—ì„œ ì˜¨ ê²ƒì¸ì§€(ê°’ì´ `false`)ë¥¼ ë‚˜íƒ€ë‚´ëŠ” ë¶ˆë¦¬ì–¸ ê°’ì…ë‹ˆë‹¤.

```csharp
protected virtual void Dispose(bool disposing)
{
    if (_disposed)
    {
        return;
    }

    if (disposing)
    {
        // Dispose managed state (managed objects).
        // ...
    }

    // Free unmanaged resources.
    // ...

    _disposed = true;
}
```

> âš ï¸ ì¤‘ìš”
> 
> `disposing` ë§¤ê°œë³€ìˆ˜ëŠ” íŒŒì´ë„ë¼ì´ì €ì—ì„œ í˜¸ì¶œë  ë•ŒëŠ” `false`ì—¬ì•¼ í•˜ê³ , `IDisposable.Dispose` ë©”ì„œë“œì—ì„œ í˜¸ì¶œë  ë•ŒëŠ” `true`ì—¬ì•¼ í•©ë‹ˆë‹¤. ë‹¤ì‹œ ë§í•´, ëª…ì‹œì ìœ¼ë¡œ í˜¸ì¶œë  ë•ŒëŠ” `true`, ë¹„ê²°ì •ì ìœ¼ë¡œ í˜¸ì¶œë  ë•ŒëŠ” `false`ì…ë‹ˆë‹¤.

ë©”ì„œë“œ ë³¸ë¬¸ì€ ì„¸ ê°œì˜ ì½”ë“œ ë¸”ë¡ìœ¼ë¡œ êµ¬ì„±ë©ë‹ˆë‹¤:

- ê°ì²´ê°€ ì´ë¯¸ í•´ì œëœ ê²½ìš° ì¡°ê±´ì ìœ¼ë¡œ ë°˜í™˜í•˜ëŠ” ë¸”ë¡.

- ê´€ë¦¬ë˜ëŠ” ë¦¬ì†ŒìŠ¤ë¥¼ í•´ì œí•˜ëŠ” ì¡°ê±´ë¶€ ë¸”ë¡. ì´ ë¸”ë¡ì€ `disposing` ê°’ì´ `true`ì¼ ë•Œ ì‹¤í–‰ë©ë‹ˆë‹¤. ì—¬ê¸°ì„œ í•´ì œí•  ìˆ˜ ìˆëŠ” ê´€ë¦¬ë˜ëŠ” ë¦¬ì†ŒìŠ¤ì—ëŠ” ë‹¤ìŒì´ í¬í•¨ë©ë‹ˆë‹¤:
  
  - `IDisposable`ì„ êµ¬í˜„í•œ ê´€ë¦¬ë˜ëŠ” ê°ì²´. ì´ ì¡°ê±´ë¶€ ë¸”ë¡ì„ í†µí•´ ì´ë“¤ì˜ `Dispose` êµ¬í˜„ì„ í˜¸ì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤(ì—°ì‡„ Dispose). ê´€ë¦¬ë˜ì§€ ì•ŠëŠ” ë¦¬ì†ŒìŠ¤ë¥¼ `System.Runtime.InteropServices.SafeHandle`ì˜ íŒŒìƒ í´ë˜ìŠ¤ë¡œ ë˜í•‘í•œ ê²½ìš°, ì´ ìë¦¬ì—ì„œ `SafeHandle.Dispose()`ë¥¼ í˜¸ì¶œí•´ì•¼ í•©ë‹ˆë‹¤.
  
  - ëŒ€ëŸ‰ì˜ ë©”ëª¨ë¦¬ë¥¼ ì‚¬ìš©í•˜ê±°ë‚˜ ì œí•œëœ ë¦¬ì†ŒìŠ¤ë¥¼ ì‚¬ìš©í•˜ëŠ” ê´€ë¦¬ë˜ëŠ” ê°ì²´. í° ê´€ë¦¬ ê°ì²´ ì°¸ì¡°ë¥¼ `null`ë¡œ ì„¤ì •í•˜ì—¬ ë„ë‹¬ ë¶ˆê°€ëŠ¥ ìƒíƒœë¡œ ë§Œë“œëŠ” ê²ƒì´ ì¼ë°˜ì ì…ë‹ˆë‹¤. ì´ë ‡ê²Œ í•˜ë©´ ë¹„ê²°ì •ì ìœ¼ë¡œ íšŒìˆ˜ë˜ëŠ” ê²ƒë³´ë‹¤ ë¹ ë¥´ê²Œ í•´ì œë©ë‹ˆë‹¤.

- ê´€ë¦¬ë˜ì§€ ì•ŠëŠ” ë¦¬ì†ŒìŠ¤ë¥¼ í•´ì œí•˜ëŠ” ë¸”ë¡. ì´ ë¸”ë¡ì€ `disposing` ë§¤ê°œë³€ìˆ˜ì˜ ê°’ê³¼ ê´€ê³„ì—†ì´ í•­ìƒ ì‹¤í–‰ë©ë‹ˆë‹¤.

ë©”ì„œë“œ í˜¸ì¶œì´ íŒŒì´ë„ë¼ì´ì €ì—ì„œ ì˜¨ ê²½ìš°, ê´€ë¦¬ë˜ì§€ ì•ŠëŠ” ë¦¬ì†ŒìŠ¤ë¥¼ í•´ì œí•˜ëŠ” ì½”ë“œë§Œ ì‹¤í–‰ë˜ì–´ì•¼ í•©ë‹ˆë‹¤. êµ¬í˜„ìëŠ” `false` ê²½ë¡œì—ì„œ ì´ë¯¸ í•´ì œëœ ê´€ë¦¬ ê°ì²´ì™€ ìƒí˜¸ì‘ìš©í•˜ì§€ ì•Šë„ë¡ ì£¼ì˜í•´ì•¼ í•©ë‹ˆë‹¤. ì´ëŠ” ê°€ë¹„ì§€ ì»¬ë ‰í„°ê°€ íŒŒì´ë„ë¼ì´ì œì´ì…˜ ì¤‘ ê´€ë¦¬ ê°ì²´ë¥¼ í•´ì œí•˜ëŠ” ìˆœì„œê°€ ë¹„ê²°ì •ì ì´ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.

## Dispose íŒ¨í„´ êµ¬í˜„

`sealed`ê°€ ì•„ë‹Œ ëª¨ë“  í´ë˜ìŠ¤(ë˜ëŠ” Visual Basicì—ì„œ `NotInheritable`ë¡œ ì§€ì •ë˜ì§€ ì•Šì€ í´ë˜ìŠ¤)ëŠ” ìƒì†ë  ê°€ëŠ¥ì„±ì´ ìˆëŠ” ê¸°ë³¸ í´ë˜ìŠ¤ í›„ë³´ë¡œ ê°„ì£¼ë©ë‹ˆë‹¤. ë§Œì•½ ì´ëŸ¬í•œ í´ë˜ìŠ¤ì—ì„œ ë””ìŠ¤í¬ì¦ˆ íŒ¨í„´ì„ êµ¬í˜„í•œë‹¤ë©´, ë‹¤ìŒ ë©”ì„œë“œë“¤ì„ ë°˜ë“œì‹œ í´ë˜ìŠ¤ì— í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤:

- `Dispose(bool)` ë©”ì„œë“œë¥¼ í˜¸ì¶œí•˜ëŠ” `Dispose` êµ¬í˜„.

- ì‹¤ì œ ì •ë¦¬ ì‘ì—…ì„ ìˆ˜í–‰í•˜ëŠ” `Dispose(bool)` ë©”ì„œë“œ.

- ê´€ë¦¬ë˜ì§€ ì•ŠëŠ” ë¦¬ì†ŒìŠ¤ë¥¼ ë‹¤ë£¨ëŠ” ê²½ìš°, `Object.Finalize` ë©”ì„œë“œë¥¼ ì˜¤ë²„ë¼ì´ë“œí•˜ê±°ë‚˜ ê´€ë¦¬ë˜ì§€ ì•ŠëŠ” ë¦¬ì†ŒìŠ¤ë¥¼ `SafeHandle`ë¡œ ë˜í•‘.

ì´ë ‡ê²Œ í•˜ë©´, íŒŒìƒ í´ë˜ìŠ¤ë„ ì•ˆì „í•˜ê³  ì •í™•í•˜ê²Œ ì •ë¦¬ ì‘ì—…ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆëŠ” ê¸°ë°˜ì„ ê°–ê²Œ ë©ë‹ˆë‹¤.

> íŒŒì´ë„ë¼ì´ì €(ì¦‰, `Object.Finalize` ì˜¤ë²„ë¼ì´ë“œ)ëŠ” ê´€ë¦¬ë˜ì§€ ì•ŠëŠ” ë¦¬ì†ŒìŠ¤ë¥¼ ì§ì ‘ ì°¸ì¡°í•  ë•Œë§Œ í•„ìš”í•©ë‹ˆë‹¤. ì´ ì‹œë‚˜ë¦¬ì˜¤ëŠ” ê³ ê¸‰ ì‹œë‚˜ë¦¬ì˜¤ë¡œ, ë³´í†µì€ í”¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
> 
> - í´ë˜ìŠ¤ê°€ ê´€ë¦¬ë˜ëŠ” ê°ì²´ë§Œ ì°¸ì¡°í•œë‹¤ë©´, ë””ìŠ¤í¬ì¦ˆ íŒ¨í„´ì„ êµ¬í˜„í•˜ë”ë¼ë„ íŒŒì´ë„ë¼ì´ì €ë¥¼ êµ¬í˜„í•  í•„ìš”ëŠ” ì—†ìŠµë‹ˆë‹¤.
> 
> - ê´€ë¦¬ë˜ì§€ ì•ŠëŠ” ë¦¬ì†ŒìŠ¤ë¥¼ ë‹¤ë¤„ì•¼ í•œë‹¤ë©´, ê´€ë¦¬ë˜ì§€ ì•ŠëŠ” `IntPtr` í•¸ë“¤ì„ `SafeHandle`ë¡œ ë˜í•‘í•˜ëŠ” ê²ƒì„ ê°•ë ¥íˆ ê¶Œì¥í•©ë‹ˆë‹¤. `SafeHandle`ì€ ìì²´ì ìœ¼ë¡œ íŒŒì´ë„ë¼ì´ì €ë¥¼ ì œê³µí•˜ë¯€ë¡œ, ì§ì ‘ ì‘ì„±í•  í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤. ìì„¸í•œ ë‚´ìš©ì€ Safe handles í•­ëª©ì„ ì°¸ê³ í•˜ì„¸ìš”.

### ê´€ë¦¬ë˜ëŠ” ë¦¬ì†ŒìŠ¤ë¥¼ ê°€ì§„ Base í´ë˜ìŠ¤

ë‹¤ìŒì€ ê´€ë¦¬ë˜ëŠ” ë¦¬ì†ŒìŠ¤ë§Œ ì†Œìœ í•˜ëŠ” ê¸°ë³¸ í´ë˜ìŠ¤ì—ì„œ ë””ìŠ¤í¬ì¦ˆ íŒ¨í„´ì„ êµ¬í˜„í•˜ëŠ” ì¼ë°˜ì ì¸ ì˜ˆì œì…ë‹ˆë‹¤.

```csharp
using System;
using System.IO;

public class DisposableBase : IDisposable
{
    // Detect redundant Dispose() calls.
    private bool _isDisposed;

    // Instantiate a disposable object owned by this class.
    private Stream? _managedResource = new MemoryStream();

    // Public implementation of Dispose pattern callable by consumers.
    public void Dispose()
    {
        Dispose(true);
        GC.SuppressFinalize(this);
    }

    // Protected implementation of Dispose pattern.
    protected virtual void Dispose(bool disposing)
    {
        if (!_isDisposed)
        {
            _isDisposed = true;

            if (disposing)
            {
                // Dispose managed state.
                _managedResource?.Dispose();
                _managedResource = null;
            }
        }
    }
}
```

> ğŸ’¡ ì°¸ê³ 
> 
> ì´ì „ ì˜ˆì œëŠ” ë””ìŠ¤í¬ì¦ˆ íŒ¨í„´ì„ ì„¤ëª…í•˜ê¸° ìœ„í•´ ê°€ìƒì˜ `MemoryStream` ê°ì²´ë¥¼ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤. ëŒ€ì‹  ì–´ë–¤ `IDisposable` ê°ì²´ë¼ë„ ì‚¬ìš©ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### ê´€ë¦¬ë˜ì§€ ì•ŠëŠ” ë¦¬ì†ŒìŠ¤ë¥¼ ê°€ì§„ ê¸°ë³¸ í´ë˜ìŠ¤

ë‹¤ìŒì€ `Object.Finalize`ë¥¼ ì˜¤ë²„ë¼ì´ë“œí•˜ì—¬ ê´€ë¦¬ë˜ì§€ ì•ŠëŠ” ë¦¬ì†ŒìŠ¤ë¥¼ ì •ë¦¬í•˜ëŠ” ê¸°ë³¸ í´ë˜ìŠ¤ì˜ ë””ìŠ¤í¬ì¦ˆ íŒ¨í„´ êµ¬í˜„ ì˜ˆì œì…ë‹ˆë‹¤. ì´ ì˜ˆì œëŠ” ë˜í•œ `Dispose(bool)`ë¥¼ ìŠ¤ë ˆë“œ ì•ˆì „í•˜ê²Œ êµ¬í˜„í•˜ëŠ” ë°©ë²•ì„ ë³´ì—¬ì¤ë‹ˆë‹¤. ë‹¤ì¤‘ ìŠ¤ë ˆë“œ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ê´€ë¦¬ë˜ì§€ ì•ŠëŠ” ë¦¬ì†ŒìŠ¤ë¥¼ ë‹¤ë£° ë•Œ ë™ê¸°í™”ëŠ” ì¤‘ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì•ì„œ ì–¸ê¸‰í–ˆë“¯, ì´ ì‹œë‚˜ë¦¬ì˜¤ëŠ” ê³ ê¸‰ ì‹œë‚˜ë¦¬ì˜¤ì…ë‹ˆë‹¤.

```csharp
using System;
using System.IO;
using System.Runtime.InteropServices;
using System.Threading;

public class DisposableBaseWithFinalizer : IDisposable
{
    // Detect redundant Dispose() calls in a thread-safe manner.
    // _isDisposed == 0 means Dispose(bool) has not been called yet.
    // _isDisposed == 1 means Dispose(bool) has been already called.
    private int _isDisposed;

    // Instantiate a disposable object owned by this class.
    private Stream? _managedResource = new MemoryStream();

    // A pointer to 10 bytes allocated on the unmanaged heap.
    private IntPtr _unmanagedResource = Marshal.AllocHGlobal(10);

    ~DisposableBaseWithFinalizer() => Dispose(false);

    // Public implementation of Dispose pattern callable by consumers.
    public void Dispose()
    {
        Dispose(true);
        GC.SuppressFinalize(this);
    }

    // Protected implementation of Dispose pattern.
    protected virtual void Dispose(bool disposing)
    {
        // In case _isDisposed is 0, atomically set it to 1.
        // Enter the branch only if the original value is 0.
        if (Interlocked.CompareExchange(ref _isDisposed, 1, 0) == 0)
        {
            if (disposing)
            {
                _managedResource?.Dispose();
                _managedResource = null;
            }

            Marshal.FreeHGlobal(_unmanagedResource);
        }
    }
}
```

> ğŸ’¡ ì°¸ê³ 
> 
> - ì´ì „ ì˜ˆì œì—ì„œëŠ” `AllocHGlobal`ì„ ì‚¬ìš©í•˜ì—¬ ìƒì„±ìì—ì„œ ê´€ë¦¬ë˜ì§€ ì•ŠëŠ” í™ì— 10ë°”ì´íŠ¸ë¥¼ í• ë‹¹í•˜ê³ , `Dispose(bool)`ì—ì„œ `FreeHGlobal`ì„ í˜¸ì¶œí•˜ì—¬ ë²„í¼ë¥¼ í•´ì œí–ˆìŠµë‹ˆë‹¤. ì´ ì˜ˆì œëŠ” ë‹¨ìˆœíˆ ì„¤ëª…ì„ ìœ„í•œ ê°€ìƒì˜ í• ë‹¹ì…ë‹ˆë‹¤.  
> 
> - ë‹¤ì‹œ ë§í•˜ì§€ë§Œ, íŒŒì´ë„ë¼ì´ì €ë¥¼ êµ¬í˜„í•˜ì§€ ì•ŠëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤. ì•ì„  ì˜ˆì œì˜ ë™ë“±í•œ ê¸°ëŠ¥ì„ ì•ˆì „í•˜ê²Œ ìˆ˜í–‰í•˜ê³ , ë¹„ê²°ì •ì  ì •ë¦¬ì™€ ë™ê¸°í™”ë¥¼ `SafeHandle`ì— ìœ„ì„í•˜ëŠ” ë°©ì‹ì„ ë³´ë ¤ë©´ â€œì‚¬ìš©ì ì •ì˜ ì•ˆì „ í•¸ë“¤ì„ ì‚¬ìš©í•œ ë””ìŠ¤í¬ì¦ˆ íŒ¨í„´ êµ¬í˜„â€ì„ ì°¸ê³ í•˜ì„¸ìš”.



> ğŸ’¡ íŒ
> 
> C#ì—ì„œ íŒŒì´ë„ë¼ì´ì œì´ì…˜ì€ `Object.Finalize`ë¥¼ ì˜¤ë²„ë¼ì´ë“œí•˜ëŠ” ë°©ì‹ì´ ì•„ë‹ˆë¼, íŒŒì´ë„ë¼ì´ì €(ì†Œë©¸ì)ë¥¼ ì •ì˜í•˜ì—¬ êµ¬í˜„ë©ë‹ˆë‹¤.  
> Visual Basicì—ì„œëŠ” `Protected Overrides Sub Finalize()`ë¥¼ ì‚¬ìš©í•˜ì—¬ íŒŒì´ë„ë¼ì´ì €ë¥¼ ë§Œë“­ë‹ˆë‹¤.

### íŒŒìƒ í´ë˜ìŠ¤ì—ì„œ Dispose íŒ¨í„´ êµ¬í˜„í•˜ê¸°

`IDisposable` ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•˜ëŠ” ê¸°ë³¸ í´ë˜ìŠ¤ë¡œë¶€í„° íŒŒìƒëœ í´ë˜ìŠ¤ëŠ”, `IDisposable`ì„ ë‹¤ì‹œ êµ¬í˜„í•  í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ í´ë˜ìŠ¤ì˜ `IDisposable.Dispose` êµ¬í˜„ì´ íŒŒìƒ í´ë˜ìŠ¤ì— ìƒì†ë˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤. ëŒ€ì‹ , íŒŒìƒ í´ë˜ìŠ¤ì˜ ì •ë¦¬ ì‘ì—…ì„ ìˆ˜í–‰í•˜ê¸° ìœ„í•´ ë‹¤ìŒì„ ì œê³µí•´ì•¼ í•©ë‹ˆë‹¤:

- ê¸°ë³¸ í´ë˜ìŠ¤ ë©”ì„œë“œë¥¼ ì˜¤ë²„ë¼ì´ë“œí•˜ëŠ” `protected override void Dispose(bool)` ë©”ì„œë“œ. ì´ ë©”ì„œë“œëŠ” íŒŒìƒ í´ë˜ìŠ¤ì˜ ì‹¤ì œ ì •ë¦¬ ì‘ì—…ì„ ìˆ˜í–‰í•˜ë©°, ë°˜ë“œì‹œ `base.Dispose(bool)`(Visual Basicì—ì„œëŠ” `MyBase.Dispose(bool)`)ì„ í˜¸ì¶œí•˜ê³  `disposing` ìƒíƒœë¥¼ ì „ë‹¬í•´ì•¼ í•©ë‹ˆë‹¤.

- ê´€ë¦¬ë˜ì§€ ì•ŠëŠ” ë¦¬ì†ŒìŠ¤ë¥¼ ë˜í•‘í•˜ëŠ” `SafeHandle`ì—ì„œ íŒŒìƒëœ í´ë˜ìŠ¤(ê¶Œì¥) ë˜ëŠ” `Object.Finalize` ë©”ì„œë“œë¥¼ ì˜¤ë²„ë¼ì´ë“œí•œ êµ¬í˜„. `SafeHandle` í´ë˜ìŠ¤ëŠ” íŒŒì´ë„ë¼ì´ì €ë¥¼ ì œê³µí•˜ë¯€ë¡œ, ì´ë¥¼ ì‚¬ìš©í•˜ë©´ íŒŒì´ë„ë¼ì´ì €ë¥¼ ì§ì ‘ ì‘ì„±í•  í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤. ë§Œì•½ íŒŒì´ë„ë¼ì´ì €ë¥¼ ì œê³µí•´ì•¼ í•œë‹¤ë©´, ë°˜ë“œì‹œ `Dispose(bool)`ë¥¼ `false` ì¸ìë¡œ í˜¸ì¶œí•´ì•¼ í•©ë‹ˆë‹¤.

ë‹¤ìŒì€ `SafeHandle`ì„ ì‚¬ìš©í•˜ëŠ” íŒŒìƒ í´ë˜ìŠ¤ì˜ ë””ìŠ¤í¬ì¦ˆ íŒ¨í„´ êµ¬í˜„ì˜ ì¼ë°˜ì ì¸ ì˜ˆì œì…ë‹ˆë‹¤:

```csharp
using System.IO;

public class DisposableDerived : DisposableBase
{
    // To detect redundant calls
    private bool _isDisposed;

    // Instantiate a disposable object owned by this class.
    private Stream? _managedResource = new MemoryStream();

    // Protected implementation of Dispose pattern.
    protected override void Dispose(bool disposing)
    {
        if (!_isDisposed)
        {
            _isDisposed = true;

            if (disposing)
            {
                _managedResource?.Dispose();
                _managedResource = null;
            }
        }

        // Call base class implementation.
        base.Dispose(disposing);
    }
}
```

> ğŸ’¡ ì°¸ê³ 
> 
> ì´ì „ ì˜ˆì œì—ì„œëŠ” ë””ìŠ¤í¬ì¦ˆ íŒ¨í„´ì„ ì„¤ëª…í•˜ê¸° ìœ„í•´ `SafeFileHandle` ê°ì²´ë¥¼ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ `SafeHandle`ì—ì„œ íŒŒìƒëœ ë‹¤ë¥¸ ê°ì²´ë„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì˜ˆì œëŠ” `SafeFileHandle` ê°ì²´ë¥¼ ì ì ˆíˆ ì¸ìŠ¤í„´ìŠ¤í™”í•˜ì§€ëŠ” ì•Šì•˜ë‹¤ëŠ” ì ì— ì£¼ì˜í•˜ì„¸ìš”.

ë‹¤ìŒì€ `Object.Finalize`ë¥¼ ì˜¤ë²„ë¼ì´ë“œí•˜ëŠ” íŒŒìƒ í´ë˜ìŠ¤ì—ì„œ ë””ìŠ¤í¬ì¦ˆ íŒ¨í„´ì„ êµ¬í˜„í•˜ëŠ” ì¼ë°˜ì ì¸ íŒ¨í„´ì…ë‹ˆë‹¤:

```csharp
using System.Threading;

public class DisposableDerivedWithFinalizer : DisposableBaseWithFinalizer
{
    // Detect redundant Dispose() calls in a thread-safe manner.
    // _isDisposed == 0 means Dispose(bool) has not been called yet.
    // _isDisposed == 1 means Dispose(bool) has been already called.
    private int _isDisposed;

    ~DisposableDerivedWithFinalizer() => Dispose(false);

    // Protected implementation of Dispose pattern.
    protected override void Dispose(bool disposing)
    {
        // In case _isDisposed is 0, atomically set it to 1.
        // Enter the branch only if the original value is 0.
        if (Interlocked.CompareExchange(ref _isDisposed, 1, 0) == 0)
        {
            if (disposing)
            {
                // TODO: dispose managed state (managed objects).
            }

            // TODO: free unmanaged resources (unmanaged objects) and override a finalizer below.
            // TODO: set large fields to null.
        }

        // Call the base class implementation.
        base.Dispose(disposing);
    }
}
```

## Safe handles

ê°ì²´ì˜ íŒŒì´ë„ë¼ì´ì €ë¥¼ ì§ì ‘ ì‘ì„±í•˜ëŠ” ê²ƒì€ ë³µì¡í•œ ì‘ì—…ì´ë©°, ì˜¬ë°”ë¥´ê²Œ êµ¬í˜„ë˜ì§€ ì•Šìœ¼ë©´ ë¬¸ì œë¥¼ ì¼ìœ¼í‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë”°ë¼ì„œ íŒŒì´ë„ë¼ì´ì €ë¥¼ êµ¬í˜„í•˜ëŠ” ëŒ€ì‹  `System.Runtime.InteropServices.SafeHandle` ê°ì²´ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì„ ê¶Œì¥í•©ë‹ˆë‹¤.

`System.Runtime.InteropServices.SafeHandle`ì€ ê´€ë¦¬ë˜ì§€ ì•ŠëŠ” ë¦¬ì†ŒìŠ¤ë¥¼ ì‹ë³„í•˜ëŠ” `System.IntPtr`ì„ ë˜í•‘í•˜ëŠ” ì¶”ìƒ ê´€ë¦¬í˜• íƒ€ì…ì…ë‹ˆë‹¤. Windowsì—ì„œëŠ” í•¸ë“¤, Unixì—ì„œëŠ” íŒŒì¼ ë””ìŠ¤í¬ë¦½í„°ë¥¼ ì‹ë³„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. `SafeHandle`ì€ ì´ ë¦¬ì†ŒìŠ¤ê°€ í•œ ë²ˆë§Œ ì •í™•íˆ í•´ì œë˜ë„ë¡ ë³´ì¥í•˜ëŠ” ëª¨ë“  ë¡œì§ì„ ì œê³µí•©ë‹ˆë‹¤. `SafeHandle`ì´ Disposeë  ë•Œ, í˜¹ì€ `SafeHandle`ì˜ ëª¨ë“  ì°¸ì¡°ê°€ í•´ì œë˜ì–´ `SafeHandle` ì¸ìŠ¤í„´ìŠ¤ê°€ íŒŒì´ë„ë¼ì´ì¦ˆë  ë•Œ ì´ ë¦¬ì†ŒìŠ¤ëŠ” í•´ì œë©ë‹ˆë‹¤.

`System.Runtime.InteropServices.SafeHandle`ì€ ì¶”ìƒ ê¸°ë³¸ í´ë˜ìŠ¤ì…ë‹ˆë‹¤. íŒŒìƒ í´ë˜ìŠ¤ëŠ” ë‹¤ì–‘í•œ ì¢…ë¥˜ì˜ í•¸ë“¤ì„ ë‹¤ë£¨ê¸° ìœ„í•œ êµ¬ì²´ì  ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì œê³µí•©ë‹ˆë‹¤. ì´ëŸ¬í•œ íŒŒìƒ í´ë˜ìŠ¤ëŠ” ì–´ë–¤ `System.IntPtr` ê°’ì´ ìœ íš¨í•˜ì§€ ì•Šì€ì§€ë¥¼ ê²€ì¦í•˜ê³ , í•¸ë“¤ì„ ì‹¤ì œë¡œ ì–´ë–»ê²Œ í•´ì œí• ì§€ë¥¼ ì •ì˜í•©ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, `SafeFileHandle`ì€ `SafeHandle`ì—ì„œ íŒŒìƒë˜ì–´ ì—´ë ¤ ìˆëŠ” íŒŒì¼ í•¸ë“¤ê³¼ ë””ìŠ¤í¬ë¦½í„°ë¥¼ ì‹ë³„í•˜ëŠ” `IntPtr`ì„ ë˜í•‘í•˜ê³ , Unixì—ì„œëŠ” `close` í•¨ìˆ˜, Windowsì—ì„œëŠ” `CloseHandle` í•¨ìˆ˜ë¥¼ í†µí•´ ë‹«ë„ë¡ `SafeHandle.ReleaseHandle()`ì„ ì˜¤ë²„ë¼ì´ë“œí•©ë‹ˆë‹¤. .NET ë¼ì´ë¸ŒëŸ¬ë¦¬ì˜ ëŒ€ë¶€ë¶„ì˜ APIëŠ” ê´€ë¦¬ë˜ì§€ ì•ŠëŠ” ë¦¬ì†ŒìŠ¤ë¥¼ ìƒì„±í•  ë•Œ ì´ë¥¼ `SafeHandle`ë¡œ ë˜í•‘í•´ì„œ ë°˜í™˜í•´ ì£¼ë©°, ì›ì‹œ í¬ì¸í„°ë¥¼ ì§ì ‘ ë°˜í™˜í•˜ì§€ëŠ” ì•ŠìŠµë‹ˆë‹¤. ê´€ë¦¬ë˜ì§€ ì•ŠëŠ” êµ¬ì„± ìš”ì†Œì™€ ìƒí˜¸ì‘ìš©í•˜ê³  ê´€ë¦¬ë˜ì§€ ì•ŠëŠ” ë¦¬ì†ŒìŠ¤ì˜ `IntPtr`ì„ ì–»ì€ ê²½ìš°, ì´ë¥¼ ë˜í•‘í•˜ëŠ” ìì²´ `SafeHandle` íƒ€ì…ì„ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê·¸ ê²°ê³¼, ëŒ€ë¶€ë¶„ì˜ ê²½ìš° `SafeHandle`ì´ ì•„ë‹Œ íƒ€ì…ì€ íŒŒì´ë„ë¼ì´ì €ë¥¼ êµ¬í˜„í•  í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤. ëŒ€ë¶€ë¶„ì˜ Dispose íŒ¨í„´ êµ¬í˜„ì€ ê²°êµ­ ë‹¤ë¥¸ ê´€ë¦¬ ë¦¬ì†ŒìŠ¤ë¥¼ ë˜í•‘í•˜ê²Œ ë˜ë©°, ì´ ì¤‘ ì¼ë¶€ëŠ” `SafeHandle` ê°ì²´ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### ì‚¬ìš©ì ì •ì˜ SafeHandleì„ ì‚¬ìš©í•œ Dispose íŒ¨í„´ êµ¬í˜„í•˜ê¸°

ë‹¤ìŒ ì½”ë“œëŠ” `SafeHandle`ì„ êµ¬í˜„í•˜ì—¬ ê´€ë¦¬ë˜ì§€ ì•ŠëŠ” ë¦¬ì†ŒìŠ¤ë¥¼ ì²˜ë¦¬í•˜ëŠ” ë°©ë²•ì„ ë³´ì—¬ì¤ë‹ˆë‹¤.

```csharp
using System;
using System.IO;
using System.Runtime.InteropServices;
using Microsoft.Win32.SafeHandles;

// Wraps the IntPtr allocated by Marshal.AllocHGlobal() into a SafeHandle.
class LocalAllocHandle : SafeHandleZeroOrMinusOneIsInvalid
{
    private LocalAllocHandle() : base(ownsHandle: true) { }

    // No need to implement a finalizer - SafeHandle's finalizer will call ReleaseHandle for you.
    protected override bool ReleaseHandle()
    {
        Marshal.FreeHGlobal(handle);
        return true;
    }

    // Allocate bytes with Marshal.AllocHGlobal() and wrap the result into a SafeHandle.
    public static LocalAllocHandle Allocate(int numberOfBytes)
    {
        IntPtr nativeHandle = Marshal.AllocHGlobal(numberOfBytes);
        LocalAllocHandle safeHandle = new LocalAllocHandle();
        safeHandle.SetHandle(nativeHandle);
        return safeHandle;
    }
}

public class DisposableBaseWithSafeHandle : IDisposable
{
    // Detect redundant Dispose() calls.
    private bool _isDisposed;

    // Managed disposable objects owned by this class
    private LocalAllocHandle? _safeHandle = LocalAllocHandle.Allocate(10);
    private Stream? _otherUnmanagedResource = new MemoryStream();

    // Public implementation of Dispose pattern callable by consumers.
    public void Dispose()
    {
        Dispose(true);
        GC.SuppressFinalize(this);
    }

    // Protected implementation of Dispose pattern.
    protected virtual void Dispose(bool disposing)
    {
        if (!_isDisposed)
        {
            _isDisposed = true;

            if (disposing)
            {
                // Dispose managed state.
                _otherUnmanagedResource?.Dispose();
                _safeHandle?.Dispose();
                _otherUnmanagedResource = null;
                _safeHandle = null;
            }
        }
    }
}
```

> ğŸ’¡ ì°¸ê³ 
> 
> `DisposableBaseWithSafeHandle` í´ë˜ìŠ¤ì˜ ë™ì‘ì€ ì´ì „ ì˜ˆì œì˜ `DisposableBaseWithFinalizer` í´ë˜ìŠ¤ì™€ ë™ì¼í•˜ì§€ë§Œ, ì—¬ê¸°ì—ì„œ ë³´ì—¬ì¤€ ë°©ì‹ì€ ë” ì•ˆì „í•©ë‹ˆë‹¤:
> 
> - SafeHandleì´ íŒŒì´ë„ë¼ì´ì œì´ì…˜ì„ ì²˜ë¦¬í•˜ë¯€ë¡œ íŒŒì´ë„ë¼ì´ì €ë¥¼ êµ¬í˜„í•  í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤.
> 
> - ìŠ¤ë ˆë“œ ì•ˆì „ì„ ë³´ì¥í•˜ê¸° ìœ„í•œ ë™ê¸°í™”ê°€ í•„ìš”í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. `DisposableBaseWithSafeHandle`ì˜ Dispose êµ¬í˜„ì— ê²½í•© ì¡°ê±´(race condition)ì´ ìˆë”ë¼ë„, SafeHandleì´ `SafeHandle.ReleaseHandle`ì´ ì •í™•íˆ í•œ ë²ˆë§Œ í˜¸ì¶œë˜ë„ë¡ ë³´ì¥í•©ë‹ˆë‹¤.

## **.NETì˜ ê¸°ë³¸ ì œê³µ SafeHandle ëª©ë¡**

ë‹¤ìŒì€ [Microsoft.Win32.SafeHandles]([Microsoft.Win32.SafeHandles Namespace | Microsoft Learn](https://learn.microsoft.com/en-us/dotnet/api/microsoft.win32.safehandles?view=net-9.0)) ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì—ì„œ ì œê³µí•˜ëŠ” íŒŒìƒ í´ë˜ìŠ¤ë“¤ë¡œ, ì•ˆì „í•œ í•¸ë“¤ì„ ì œê³µí•©ë‹ˆë‹¤.

# ì°¸ì¡°

- [MSDN: Cleaning up unmanaged resources]([Cleaning up unmanaged resources - .NET | Microsoft Learn](https://learn.microsoft.com/en-us/dotnet/standard/garbage-collection/unmanaged))

- [MSDN: Implement a Dispose method]([Implement a Dispose method - .NET | Microsoft Learn](https://learn.microsoft.com/en-us/dotnet/standard/garbage-collection/implementing-dispose))
